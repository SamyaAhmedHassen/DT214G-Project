<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DiagramTabToolBar.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JetUML</a> &gt; <a href="index.source.html" class="el_package">org.jetuml.gui</a> &gt; <span class="el_source">DiagramTabToolBar.java</span></div><h1>DiagramTabToolBar.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * JetUML - A desktop application for fast UML diagramming.
 *
 * Copyright (C) 2025 by McGill University.
 *     
 * See: https://github.com/prmr/JetUML
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses.
 *******************************************************************************/
package org.jetuml.gui;

import static org.jetuml.application.ApplicationResources.RESOURCES;

import java.util.List;
import java.util.Optional;

import org.jetuml.application.UserPreferences;
import org.jetuml.application.UserPreferences.BooleanPreference;
import org.jetuml.application.UserPreferences.BooleanPreferenceChangeHandler;
import org.jetuml.application.UserPreferences.IntegerPreference;
import org.jetuml.diagram.DiagramElement;
import org.jetuml.diagram.Prototypes;
import org.jetuml.geom.Rectangle;
import org.jetuml.rendering.AccessoriesRenderer;
import org.jetuml.rendering.DiagramRenderer;
import org.jetuml.rendering.GraphicsRenderingContext;
import org.jetuml.rendering.nodes.AbstractNodeRenderer;

import javafx.geometry.Orientation;
import javafx.geometry.Pos;
import javafx.scene.Node;
import javafx.scene.Parent;
import javafx.scene.canvas.Canvas;
import javafx.scene.canvas.GraphicsContext;
import javafx.scene.control.Button;
import javafx.scene.control.ButtonBase;
import javafx.scene.control.ContextMenu;
import javafx.scene.control.MenuItem;
import javafx.scene.control.ToggleButton;
import javafx.scene.control.ToggleGroup;
import javafx.scene.control.ToolBar;
import javafx.scene.control.Tooltip;
import javafx.scene.image.ImageView;

/**
 *  A tool bar than contains various tools and command shortcut buttons. 
 *  Only one tool can be selected at the time. The tool bar also controls a pop-up 
 *  menu with the same tools as the tool bar. Labels can optionally be shown next 
 *  to tools.
 */
<span class="fc" id="L62">public class DiagramTabToolBar extends ToolBar implements BooleanPreferenceChangeHandler</span>
{
<span class="fc" id="L64">	private ContextMenu aPopupMenu = new ContextMenu();</span>
	private DiagramRenderer aDiagramRenderer;

	/**
     * Constructs the tool bar.
     * 
     * @param pDiagramRenderer The renderer for the diagram associated with this tool bar.
	 */
	public DiagramTabToolBar(DiagramRenderer pDiagramRenderer)
<span class="fc" id="L73">	{</span>
<span class="fc" id="L74">		aDiagramRenderer = pDiagramRenderer;</span>
<span class="fc" id="L75">		setOrientation(Orientation.VERTICAL);</span>
<span class="fc" id="L76">		setStyle(&quot;-fx-focus-color: transparent; -fx-faint-focus-color: transparent;&quot;); </span>
<span class="fc" id="L77">		ToggleGroup toggleGroup = new ToggleGroup();</span>
		// Method setToolToBeSelect assumes the selection tool will always be the first button in the toggle group.
<span class="fc" id="L79">		installSelectionTool(toggleGroup); </span>
<span class="fc" id="L80">		installDiagramElementTools(pDiagramRenderer, toggleGroup);</span>
<span class="fc" id="L81">		installCopyToClipboard();</span>
<span class="fc" id="L82">    	showButtonLabels( UserPreferences.instance().getBoolean(BooleanPreference.showToolHints ));</span>
<span class="fc" id="L83">    	setToolToBeSelect();</span>
<span class="fc" id="L84">	}</span>
	
	// Note: it is not possible to select the Selection tool in this 
	// method because adding new toggle buttons to a toggle group has the effect
	// of eliminating the current selection.
	private void installSelectionTool(ToggleGroup pToggleGroup)
	{
<span class="fc" id="L91">		SelectableToolButton selectionButton = new SelectableToolButton(createSelectionIcon(), </span>
<span class="fc" id="L92">				RESOURCES.getString(&quot;toolbar.select.tooltip&quot;), pToggleGroup);</span>
<span class="fc" id="L93">		add(selectionButton, createSelectionIcon(), RESOURCES.getString(&quot;toolbar.select.tooltip&quot;));</span>
<span class="fc" id="L94">		UserPreferences.instance().addBooleanPreferenceChangeHandler(selectionButton);</span>
<span class="fc" id="L95">	}</span>
	
	private static Canvas createSelectionIcon()
	{
<span class="fc" id="L99">		int offset = AbstractNodeRenderer.OFFSET + 3;</span>
<span class="fc" id="L100">		Canvas canvas = new Canvas(AbstractNodeRenderer.BUTTON_SIZE, AbstractNodeRenderer.BUTTON_SIZE);</span>
<span class="fc" id="L101">		GraphicsContext graphics = canvas.getGraphicsContext2D();</span>
<span class="fc" id="L102">		new AccessoriesRenderer(new GraphicsRenderingContext(graphics)).drawHandles(new Rectangle(offset, offset, </span>
				AbstractNodeRenderer.BUTTON_SIZE - (offset*2), AbstractNodeRenderer.BUTTON_SIZE-(offset*2) ));
<span class="fc" id="L104">		return canvas;</span>
	}
	
	private void installDiagramElementTools(DiagramRenderer pDiagramRenderer, ToggleGroup pToggleGroup)
	{
<span class="fc" id="L109">		final int oldFontSize = UserPreferences.instance().getInteger(IntegerPreference.fontSize);</span>
<span class="fc" id="L110">		UserPreferences.instance().setInteger(IntegerPreference.fontSize, UserPreferences.DEFAULT_FONT_SIZE);</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">		for( DiagramElement element : pDiagramRenderer.diagram().getPrototypes() )</span>
		{
<span class="fc" id="L113">			SelectableToolButton button = new SelectableToolButton(pDiagramRenderer.createIcon(element),</span>
<span class="fc" id="L114">					Prototypes.instance().tooltip(element, </span>
<span class="fc" id="L115">							UserPreferences.instance().getBoolean(BooleanPreference.verboseToolTips)), </span>
					pToggleGroup, element);
<span class="fc" id="L117">			UserPreferences.instance().addBooleanPreferenceChangeHandler(button);</span>
<span class="fc" id="L118">			add(button, pDiagramRenderer.createIcon(element), Prototypes.instance().tooltip(element, false));</span>
<span class="fc" id="L119">		}</span>
<span class="fc" id="L120">		UserPreferences.instance().setInteger(IntegerPreference.fontSize, oldFontSize);</span>
<span class="fc" id="L121">	}</span>
	
	private void installCopyToClipboard()
	{
<span class="fc" id="L125">		final Button button = new Button();</span>
<span class="fc" id="L126">		button.setGraphic(new ImageView(RESOURCES.getString(&quot;toolbar.toclipboard.icon&quot;)));</span>
<span class="fc" id="L127">		button.setTooltip( new Tooltip(RESOURCES.getString(&quot;toolbar.toclipboard.tooltip&quot;)));</span>
<span class="fc" id="L128">		button.setOnAction(pEvent-&gt; </span>
		{
<span class="nc" id="L130">			copyToClipboard();</span>
<span class="nc" id="L131">			getSelectedTool().requestFocus();</span>
<span class="nc" id="L132">		});</span>
<span class="fc" id="L133">		button.setStyle(&quot;-fx-background-radius: 0&quot;);</span>
<span class="fc" id="L134">		button.setAlignment(Pos.BASELINE_LEFT);</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">		assert getItems().size() &gt; 0; // We copy size information from the top button</span>
<span class="fc" id="L136">		button.prefWidthProperty().bind(((ToggleButton)getItems().get(0)).widthProperty());</span>
<span class="fc" id="L137">		button.prefHeightProperty().bind(((ToggleButton)getItems().get(0)).heightProperty());</span>
<span class="fc" id="L138">		add(button, RESOURCES.getString(&quot;toolbar.toclipboard.tooltip&quot;));</span>
<span class="fc" id="L139">	}</span>
	
	/**
	 * Adds the button to this toolbar and the corresponding context menu.
	 * 
	 * @param pButton The button to add.
	 * @param pText The text for the menu
	 */
	private void add(ButtonBase pButton, String pText)
	{
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">		assert pButton != null;</span>
<span class="fc" id="L150">		getItems().add( pButton );</span>
<span class="fc" id="L151">		MenuItem item = new MenuItem(pText);</span>
<span class="fc" id="L152">		item.setGraphic(new ImageView(((ImageView)pButton.getGraphic()).getImage()));</span>
<span class="fc" id="L153">		item.setOnAction(pButton.getOnAction());</span>
<span class="fc" id="L154">		aPopupMenu.getItems().add(item);</span>
<span class="fc" id="L155">	}</span>
	
	/**
	 * Adds the button to this toolbar and the corresponding context menu.
	 * 
	 * @param pButton The button to add.
	 * @param pText The text for the menu
	 */
	private void add(ButtonBase pButton, Canvas pIcon, String pText)
	{
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">		assert pButton != null;</span>
<span class="fc" id="L166">		getItems().add( pButton );</span>
<span class="fc" id="L167">		MenuItem item = new MenuItem(pText);</span>
<span class="fc" id="L168">		item.setGraphic(pIcon);</span>
<span class="fc" id="L169">		item.setOnAction(pButton.getOnAction());</span>
<span class="fc" id="L170">		aPopupMenu.getItems().add(item);</span>
<span class="fc" id="L171">	}</span>
	
	private SelectableToolButton getSelectedTool()
	{
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">		assert getItems().size() &gt; 0;</span>
<span class="fc" id="L176">		ToggleButton button = (ToggleButton) ((ToggleButton) getItems().get(0)).getToggleGroup().getSelectedToggle();</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">		assert button != null;</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">		assert button.getClass() == SelectableToolButton.class;</span>
<span class="fc" id="L179">		return (SelectableToolButton) button;</span>
	}
	
	/**
     * Gets the node or edge prototype that is associated with
     * the currently selected button, if available. A tool is unavailable if 
     * the select tool is currently selected.
     * @return a Node or Edge prototype if present.
	 */
	public Optional&lt;DiagramElement&gt; getCreationPrototype()
	{
<span class="nc" id="L190">		return getSelectedTool().getPrototype();</span>
	}
	
	private void copyToClipboard()
	{
<span class="nc" id="L195">		Parent parent = getParent();</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">		while( parent.getClass() != EditorFrame.class )</span>
		{
<span class="nc" id="L198">			parent = parent.getParent();</span>
		}
<span class="nc" id="L200">		((EditorFrame)parent).copyToClipboard();	</span>
<span class="nc" id="L201">	}</span>
	
	/**
	 * Show the pop-up menu corresponding to this toolbar.
	 * @param pScreenXCoordinate The X-coordinate where to position the menu, in screen coordinates.
	 * @param pScreenYCoordinate The Y-coordinate where to position the menu, in screen coordinates.
	 */
	public void showPopup(double pScreenXCoordinate, double pScreenYCoordinate) 
	{
<span class="nc" id="L210">		aPopupMenu.show(this, pScreenXCoordinate, pScreenYCoordinate);</span>
<span class="nc" id="L211">	}</span>
	
	/**
	 * Overrides the currently selected tool to be the selection tool instead.
	 */
	public void setToolToBeSelect()
	{
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">		assert getItems().size() &gt; 0;</span>
<span class="fc" id="L219">		setSelectedTool(0);</span>
<span class="fc" id="L220">	}</span>
	
	/**
	 * Sets the selected tool to be the one at pIndex (zero-indexed)
	 * in the tool group. Does nothing if there is no tool at this index.
	 * 
	 * @param pIndex The desired index.
	 */
	public void setSelectedTool(int pIndex)
	{
<span class="fc" id="L230">		ToggleGroup group = ((ToggleButton)getItems().get(0)).getToggleGroup();</span>
<span class="pc bpc" id="L231" title="2 of 4 branches missed.">		if( pIndex &lt; 0 || pIndex &gt;= group.getToggles().size())</span>
		{
<span class="nc" id="L233">			return;</span>
		}
<span class="fc" id="L235">		group.getToggles().get(pIndex).setSelected(true);</span>
<span class="fc" id="L236">	}</span>
	
	/**
	 * Shows or hides the textual description of the tools and commands.
	 * @param pShow True if the labels should be shown
	 */
	private void showButtonLabels(boolean pShow)
	{
<span class="fc bfc" id="L244" title="All 2 branches covered.">		for( javafx.scene.Node item : getItems() )</span>
		{
<span class="fc" id="L246">			ButtonBase button = (ButtonBase) item;</span>
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">			if( pShow )</span>
			{
<span class="nc bnc" id="L249" title="All 2 branches missed.">				if( item instanceof SelectableToolButton toolButton &amp;&amp; </span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">						toolButton.getPrototype().isPresent())</span>
				{
<span class="nc" id="L252">					String text = Prototypes.instance().tooltip(toolButton.getPrototype().get(), false);</span>
<span class="nc" id="L253">					button.setText(text);</span>
<span class="nc" id="L254">				}</span>
				else
				{
<span class="nc" id="L257">					button.setText(button.getTooltip().getText());</span>
				}
<span class="nc" id="L259">				button.setMaxWidth(Double.MAX_VALUE);</span>
			}
			else
			{
<span class="fc" id="L263">				button.setText(&quot;&quot;);</span>
<span class="fc" id="L264">				button.autosize();</span>
			}
<span class="fc" id="L266">		}</span>
<span class="fc" id="L267">	}</span>
	
	/**
	 * Recreates the tool bar button and pop-up menu icons 
	 * when turning dark mode on or off.
	 */
	private void recreateButtonIcons()
	{
<span class="nc" id="L275">		List&lt;Node&gt; toolBarItems = getItems();</span>
<span class="nc" id="L276">		List&lt;MenuItem&gt; contextMenuItems = aPopupMenu.getItems();</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">		for( int i = 0; i &lt; toolBarItems.size(); i++ )</span>
		{
<span class="nc" id="L279">			ButtonBase button = (ButtonBase) toolBarItems.get(i);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">			if( toolBarItems.get(i) instanceof SelectableToolButton toolButton &amp;&amp; </span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">					toolButton.getPrototype().isPresent() )</span>
			{
<span class="nc" id="L283">				button.setGraphic(aDiagramRenderer.createIcon(toolButton.getPrototype().get()));</span>
<span class="nc" id="L284">				contextMenuItems.get(i).setGraphic(aDiagramRenderer.createIcon(toolButton.getPrototype().get()));</span>
			}
		}
<span class="nc" id="L287">	}</span>

	@Override
	public void booleanPreferenceChanged(BooleanPreference pPreference)
	{
<span class="nc bnc" id="L292" title="All 2 branches missed.">		if( pPreference == BooleanPreference.showToolHints )</span>
		{
<span class="nc" id="L294">			showButtonLabels(UserPreferences.instance().getBoolean(BooleanPreference.showToolHints));</span>
		}
<span class="nc bnc" id="L296" title="All 2 branches missed.">		if( pPreference == BooleanPreference.darkMode )</span>
		{
<span class="nc" id="L298">			recreateButtonIcons();</span>
		}
<span class="nc" id="L300">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>